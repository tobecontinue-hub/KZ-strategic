{% extends "base.html" %}
{% block content %}
<style>
  .org-canvas {
    position: relative;
    padding: 2rem 0;
  }
  .org-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
  }
  .tier-stack {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
  .tier {
    position: relative;
    padding-top: 1.75rem;
  }
  .tier-label {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 0.2rem 0.9rem;
    border-radius: 999px;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    background: #312e81;
    color: #fff;
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(49,46,129,.25);
  }
  .tier-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
  }
  .member-card {
    width: 230px;
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,.4);
    padding: 1rem;
    box-shadow: 0 14px 30px rgba(15,23,42,.12);
    background: #fff;
    text-align: center;
    position: relative;
  }
  .member-card::before {
    content: "";
    position: absolute;
    top: -32px;
    left: 50%;
    width: 2px;
    height: 32px;
    background: linear-gradient(180deg,#cbd5f5,#94a3b8);
    transform: translateX(-50%);
  }
  .tier:first-of-type .member-card::before { display: none; }
  .photo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    margin: 0 auto 0.5rem;
    overflow: hidden;
    border: 3px solid rgba(148,163,184,.4);
    background: #e2e8f0;
  }
  .photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .name { font-weight: 700; color: #0f172a; margin-bottom: 0.1rem; }
  .role { font-size: 0.85rem; color: #475569; margin-bottom: 0.35rem; }
  .meta {
    display: inline-flex;
    gap: 0.3rem;
    flex-wrap: wrap;
    justify-content: center;
  }
  .badge {
    padding: 0.2rem 0.45rem;
    border-radius: 999px;
    font-size: 0.7rem;
    background: #f1f5f9;
    color: #475569;
    font-weight: 600;
  }
  .badge.status-vacant { background: #fee2e2; color: #b91c1c; }
  .badge.status-active { background: #dcfce7; color: #15803d; }
  @media (max-width: 768px) {
    .member-card::before { display: none; }
    .tier-label { position: static; transform: none; margin-bottom: 0.5rem; }
  }
</style>

<div class="org-canvas" id="orgCanvas">
  <svg class="org-lines" id="orgLines"></svg>
  <div class="tier-stack" id="tierStack">
    {% for label in ["CEO", "Head", "Assistant Manager", "Executive / Developer", "Staff / Junior"] %}
      <section class="tier" data-tier-index="{{ loop.index0 }}">
        <div class="tier-label">{{ label }}</div>
        <div class="tier-row" data-tier-row></div>
      </section>
    {% endfor %}
  </div>
</div>

<script>
  const treeData = {{ root_nodes | tojson | safe }};

  const tiers = [
    { label: 'CEO', match: [/ceo/] },
    { label: 'Head', match: [/head/] },
    { label: 'Assistant Manager', match: [/assistant/, /asst/] },
    { label: 'Executive / Developer', match: [/executive/, /developer/] },
    { label: 'Staff / Junior', match: [/staff/, /junior/] }
  ];

  const tierRows = document.querySelectorAll('[data-tier-row]');
  const svg = document.getElementById('orgLines');
  const canvas = document.getElementById('orgCanvas');
  const nodeMap = new Map();

  const flatten = (nodes, parentId = null, acc = [], prefix = 'n') => {
    nodes.forEach((node, idx) => {
      const name = node.original_name || node.name || 'node';
      const safeId = `${prefix}-${idx}-${name.replace(/[^a-z0-9]+/gi,'-').toLowerCase()}`;
      const entry = {
        id: safeId,
        name,
        role: node.role || '',
        department: node.department || '',
        status: node.status || '',
        photo: node.photo_url || '',
        parentId,
        children: node.children || []
      };
      acc.push(entry);
      if (node.children && node.children.length) {
        flatten(node.children, safeId, acc, safeId);
      }
    });
    return acc;
  };

  const getTierIndex = role => {
    const lower = (role || '').toLowerCase();
    for (let i = 0; i < tiers.length; i++) {
      if (tiers[i].match.some(regex => regex.test(lower))) {
        return i;
      }
    }
    return tiers.length - 1;
  };

  const nodes = flatten(treeData);

  nodes.forEach(node => {
    const tierIndex = getTierIndex(node.role);
    const row = tierRows[tierIndex];
    if (!row) return;
    const card = document.createElement('article');
    card.className = 'member-card';
    card.dataset.nodeId = node.id;
    card.dataset.parentId = node.parentId || '';
    card.innerHTML = `
      <div class="photo">
        ${node.photo ? `<img src="${node.photo}" alt="${node.name}" onerror="this.remove();">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#475569;">${node.name.charAt(0)}</div>`}
      </div>
      <div class="name">${node.name}</div>
      <div class="role">${node.role || 'Role TBD'}</div>
      <div class="meta">
        <span class="badge">${node.department || 'Department'}</span>
        <span class="badge ${node.status.toLowerCase().includes('vacant') ? 'status-vacant' : 'status-active'}">${node.status || 'Status'}</span>
      </div>
    `;
    row.appendChild(card);
    nodeMap.set(node.id, card);
  });

  const drawLines = () => {
    const rect = canvas.getBoundingClientRect();
    svg.setAttribute('width', rect.width);
    svg.setAttribute('height', rect.height);
    svg.innerHTML = '';

    nodes.forEach(node => {
      if (!node.parentId) return;
      const childEl = nodeMap.get(node.id);
      const parentEl = nodeMap.get(node.parentId);
      if (!childEl || !parentEl) return;
      const childRect = childEl.getBoundingClientRect();
      const parentRect = parentEl.getBoundingClientRect();
      const x1 = parentRect.left + parentRect.width / 2 - rect.left;
      const y1 = parentRect.bottom - rect.top;
      const x2 = childRect.left + childRect.width / 2 - rect.left;
      const y2 = childRect.top - rect.top;
      const midY = (y1 + y2) / 2;
      const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      path.setAttribute('d', `M${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`);
      path.setAttribute('stroke', '#cbd5f5');
      path.setAttribute('fill', 'none');
      path.setAttribute('stroke-width', '2');
      svg.appendChild(path);
    });
  };

  window.addEventListener('resize', () => requestAnimationFrame(drawLines));
  drawLines();
</script>
{% endblock %}
