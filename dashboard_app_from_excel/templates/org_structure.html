{% extends "base.html" %}
{% block content %}
<style>
  :root { color-scheme: light dark; }
  .org-wrapper { max-width: 1200px; margin: 0 auto; padding: 1rem 1rem 3rem; }
  .org-wrapper h2 { text-align: center; font-weight: 800; margin-bottom: 0.35rem; }
  .org-wrapper p.subhead { text-align: center; letter-spacing: 0.3em; text-transform: uppercase; font-size: 0.75rem; color: #94a3b8; margin-bottom: 1.75rem; }
  .tree ul { padding-top: 1rem; position: relative; padding-left: 0; display: flex; justify-content: center; flex-wrap: wrap; }
  .tree li { list-style-type: none; margin: 0 0.8rem; text-align: center; position: relative; padding: 1rem 0 0 0; }
  .tree li::before,
  .tree li::after { content: ''; position: absolute; top: 0; border-top: 1px solid #d7dfe7; width: 50%; height: 1rem; }
  .tree li::before { right: 50%; }
  .tree li::after { left: 50%; border-left: 1px solid #d7dfe7; }
  .tree li:only-child::after,
  .tree li:only-child::before { display: none; }
  .tree li:only-child { padding-top: 0; }
  .tree li:first-child::before,
  .tree li:last-child::after { border: none; }
  .tree li:last-child::before { border-right: 1px solid #d7dfe7; border-radius: 0 0 0.75rem 0; }
  .tree li:first-child::after { border-radius: 0 0 0 0.75rem; }
  .node-card {
    --dept-color: #94a3b8;
    display: inline-flex;
    align-items: center;
    gap: 0.85rem;
    border-radius: 16px;
    border: 1px solid rgba(148,163,184,0.4);
    padding: 0.85rem 1rem;
    min-width: 220px;
    background: #fff;
    box-shadow: 0 14px 32px rgba(15,23,42,0.12);
    position: relative;
  }
  .node-card::after {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 16px;
    border: 2px solid var(--dept-color);
    opacity: 0.18;
    pointer-events: none;
  }
  .photo-frame {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid rgba(148,163,184,0.4);
    background: #e2e8f0;
    flex-shrink: 0;
  }
  .photo-frame img { width: 100%; height: 100%; object-fit: cover; display: block; }
  .node-name { font-weight: 700; color: #0f172a; margin-bottom: 0.1rem; }
  .node-role { font-size: 0.85rem; color: #475569; margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.08em; }
  .node-meta { display: flex; gap: 0.35rem; flex-wrap: wrap; font-size: 0.7rem; }
  .badge { padding: 0.18rem 0.45rem; border-radius: 999px; background: #f1f5f9; color: #475569; font-weight: 600; }
  .badge.status-vacant { background: #fee2e2; color: #b91c1c; }
  .badge.status-active { background: #dcfce7; color: #15803d; }
  @media (max-width: 768px) {
    .tree ul { flex-direction: column; align-items: center; }
    .tree li::before,
    .tree li::after { display: none; }
  }
</style>

{% macro render_node(node, dept_colors) %}
  {% set dept_color = dept_colors.get(node.department, '#94a3b8') %}
  <li>
    <div class="node-card" style="--dept-color: {{ dept_color }};">
      <div class="photo-frame">
        {% if node.photo_url %}
          <img src="{{ node.photo_url }}" alt="{{ node.original_name or node.name }}" onerror="this.remove();">
        {% else %}
          <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-weight:700;color:#475569;">
            {{ (node.original_name or node.name)[:1] }}
          </div>
        {% endif %}
      </div>
      <div>
        <div class="node-role">{{ node.role or 'Role TBD' }}</div>
        <div class="node-name">{{ node.original_name or node.name }}</div>
        <div class="node-meta">
          <span class="badge">{{ node.department or 'Department' }}</span>
          {% set status = node.status or '' %}
          <span class="badge {{ 'status-vacant' if 'vacant' in status|lower else 'status-active' }}">{{ status or 'Status' }}</span>
        </div>
      </div>
    </div>
    {% if node.children %}
      <ul>
        {% for child in node.children %}
          {{ render_node(child, dept_colors) }}
        {% endfor %}
      </ul>
    {% endif %}
  </li>
{% endmacro %}

<div class="org-wrapper">
  <p class="subhead">Department • Role • Reporting Line</p>
  <h2>Organization Tree</h2>
  <div class="tree">
    <ul class="root">
      {% for node in root_nodes %}
        {{ render_node(node, dept_colors) }}
      {% endfor %}
    </ul>
  </div>
</div>
{% endblock %}
