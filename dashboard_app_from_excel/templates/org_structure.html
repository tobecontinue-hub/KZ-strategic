{% extends "base.html" %}
{% block content %}
<style>
  .org-wrapper {
    padding: 1.5rem;
  }
  .org-level {
    margin-bottom: 2rem;
  }
  .org-level h4 {
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #64748b;
    margin-bottom: 0.75rem;
  }
  .org-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  .org-card {
    background: #fff;
    border-radius: 14px;
    padding: 1rem;
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
    border-top: 4px solid #0ea5e9;
    display: flex;
    gap: 0.85rem;
    align-items: center;
  }
  .org-photo {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid rgba(148, 163, 184, 0.4);
  }
  .org-placeholder {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: #334155;
  }
  .org-name {
    font-weight: 700;
    color: #0f172a;
    margin-bottom: 0.15rem;
  }
  .org-role {
    font-size: 0.85rem;
    color: #475569;
    margin-bottom: 0.35rem;
  }
  .org-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    font-size: 0.75rem;
  }
  .org-meta span {
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    background: #f1f5f9;
    color: #475569;
    font-weight: 600;
  }
</style>

<div class="org-wrapper">
  <h2 class="mb-4">Organizational Structure</h2>
  <div id="org-chart"></div>
</div>

<script>
  const orgTree = {{ root_nodes | tojson | safe }};
  const deptColors = {{ dept_colors | tojson | safe }};
  const roleColors = {{ role_colors | tojson | safe }};

  const flattenTree = (nodes, acc = []) => {
    nodes.forEach(node => {
      acc.push(node);
      if (node.children && node.children.length) {
        flattenTree(node.children, acc);
      }
    });
    return acc;
  };

  const nodes = flattenTree(orgTree);
  const levels = {};
  nodes.forEach(node => {
    const level = parseInt(node.level || 0, 10);
    if (!levels[level]) levels[level] = [];
    levels[level].push(node);
  });

  const getDeptColor = dept => (deptColors[dept] || {}).border || '#0ea5e9';
  const getRoleColor = role => (roleColors[role] || '#0ea5e9');

  const createCard = (node) => {
    const name = node.original_name || node.name || 'Unknown';
    const role = node.role || 'Role TBD';
    const dept = node.department || 'Department';
    const status = node.status || 'Status';

    const photo = node.photo_url && node.photo_url.trim().length
      ? `<img class="org-photo" src="${node.photo_url}" alt="${name}" onerror="this.remove()">`
      : `<div class="org-placeholder">${name.charAt(0)}</div>`;

    return `
      <div class="org-card" style="border-top-color:${getDeptColor(dept)}">
        ${photo}
        <div>
          <div class="org-name">${name}</div>
          <div class="org-role" style="color:${getRoleColor(role)}">${role}</div>
          <div class="org-meta">
            <span>${dept}</span>
            <span>${status}</span>
          </div>
        </div>
      </div>
    `;
  };

  const renderChart = () => {
    const container = document.getElementById('org-chart');
    const levelKeys = Object.keys(levels).map(Number).sort((a, b) => a - b);
    container.innerHTML = levelKeys.map(level => `
      <div class="org-level">
        <h4>Level ${level}</h4>
        <div class="org-grid">
          ${levels[level].map(createCard).join('')}
        </div>
      </div>
    `).join('');
  };

  renderChart();
</script>
{% endblock %}
