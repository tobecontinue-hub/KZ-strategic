{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.13/dist/tailwind.min.css">
<style>
  .node-card{border-radius:12px;box-shadow:0 12px 25px rgba(15,23,42,.12);transition:transform .2s,box-shadow .2s}
  .node-card:hover{transform:translateY(-4px);box-shadow:0 18px 35px rgba(15,23,42,.18)}
  .photo-ring{width:58px;height:58px;border-radius:50%;overflow:hidden;border:3px solid rgba(255,255,255,.7)}
  .photo-ring img{width:100%;height:100%;object-fit:cover;display:block}
  .grid-track{position:relative;padding:1.5rem 0}
  .grid-track::before{content:"";position:absolute;top:0;left:calc(50% - 1px);width:2px;height:100%;background:linear-gradient(180deg,#cbd5f5,#e0e7ff)}
</style>
<div class="max-w-6xl mx-auto px-4 py-6 space-y-8">
  <div class="text-center">
    <p class="text-xs uppercase tracking-[0.3em] text-indigo-300">Organization</p>
    <h2 class="text-3xl font-black text-slate-50">Team Structure</h2>
    <p class="text-sm text-slate-400 mt-2">Visualizes reporting layers without the heavy animated graph</p>
  </div>
  <div id="org-stripes" class="space-y-10"></div>
</div>
<script>
  const tree = {{ root_nodes|tojson|safe }};
  const flatten = (nodes, acc=[])=>{nodes.forEach(n=>{const level=parseInt(n.level||0,10);acc.push({...n,level});if(n.children?.length)flatten(n.children,acc)});return acc};
  const nodes = flatten(tree);
  const grouped = nodes.reduce((map,node)=>{map[node.level]??=[];map[node.level].push(node);return map},{});
  const levelKeys = Object.keys(grouped).map(Number).sort((a,b)=>a-b);
  const colorPalette=["bg-gradient-to-br from-indigo-500 to-sky-500","bg-gradient-to-br from-rose-500 to-orange-400","bg-gradient-to-br from-emerald-500 to-teal-500","bg-gradient-to-br from-amber-500 to-pink-500","bg-gradient-to-br from-slate-500 to-slate-700"];
  const stripes=document.getElementById("org-stripes");
  stripes.innerHTML=levelKeys.map((level,i)=>{
    const nodes = grouped[level];
    const trackColor = colorPalette[i%colorPalette.length];
    return `
      <section class="relative">
        <div class="grid-track">
          <span class="px-4 py-1 rounded-full text-xs font-semibold text-white ${trackColor}">LEVEL ${level}</span>
        </div>
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          ${nodes.map(n=>{
            const name = n.original_name || n.name || 'Unknown';
            const dept = n.department || 'Department';
            const status = (n.status || 'Status').toUpperCase();
            const role = n.role || 'Role TBD';
            const photo = n.photo_url && n.photo_url.trim().length ? `<div class="photo-ring ${trackColor}"><img src="${n.photo_url}" alt="${name}" onerror="this.closest('div').innerHTML='<span class=\'w-full h-full flex items-center justify-center text-white text-lg\'>${name.charAt(0)}</span>';"></div>` : `<div class="photo-ring ${trackColor} flex items-center justify-center text-white text-lg font-semibold">${name.charAt(0)}</div>`;
            return `
              <article class="node-card bg-slate-900/70 border border-white/5 p-4 flex gap-4">
                ${photo}
                <div>
                  <h3 class="text-base font-semibold text-white leading-tight">${name}</h3>
                  <p class="text-sm font-medium text-slate-300">${role}</p>
                  <p class="text-xs text-slate-400 mt-1">${dept}</p>
                  <span class="inline-flex mt-2 px-2 py-1 rounded-full text-[0.65rem] tracking-wide ${status.includes('VACANT') ? 'bg-red-500/20 text-red-300' : 'bg-emerald-500/20 text-emerald-200'}">${status}</span>
                </div>
              </article>
            `;
          }).join('')}
        </div>
      </section>
    `;
  }).join('');
</script>
{% endblock %}
