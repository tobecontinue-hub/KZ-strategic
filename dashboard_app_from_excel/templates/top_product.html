{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
:root {
  --card-bg: #0b1220;
  --card-glow: linear-gradient(135deg, rgba(99,102,241,.35), rgba(16,185,129,.25));
}
.top-product-stage {
  background: radial-gradient(circle at top, #1c2540, #04070f);
  padding: 32px 20px 60px;
  border-radius: 28px;
  box-shadow: 0 35px 80px rgba(3,7,18,.65);
}
.top-product-stage h1 { color:#f8fbff; font-weight:800; letter-spacing:-.4px; margin-bottom:6px; }
.top-product-stage p { color:#9fb4d9; margin-bottom:24px; }
.product-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(310px,1fr)); gap:22px; }
.product-card {
  border-radius:20px;
  background: var(--card-bg);
  border:1px solid rgba(255,255,255,.08);
  position:relative;
  overflow:visible;
  cursor:pointer;
  transition:transform .35s ease, box-shadow .35s ease;
}
.product-card-body-click { cursor:default; }
.product-card::before {
  content:"";
  position:absolute;
  inset:-2px;
  background:var(--card-glow);
  opacity:0;
  transition:opacity .35s ease;
  filter:blur(12px);
}
.product-card:hover { transform:translateY(-6px) scale(1.01); box-shadow:0 25px 50px rgba(0,0,0,.45); }
.product-card:hover::before { opacity:1; }
.card-inner { position:relative; z-index:1; }
.product-img { height:210px; background:rgba(255,255,255,.05); display:flex; align-items:center; justify-content:center; }
.product-img img { max-height:100%; max-width:100%; object-fit:contain; padding:18px; filter:drop-shadow(0 12px 18px rgba(0,0,0,.55)); }
.product-body { padding:20px 20px 0; color:#e5edff; }
.rank-badge { width:30px; height:30px; border-radius:50%; background:rgba(99,102,241,.85); display:inline-flex; align-items:center; justify-content:center; font-weight:700; margin-right:10px; }
.product-name { font-size:1.2rem; font-weight:700; }
.stat-row { display:flex; justify-content:space-between; margin:14px 0 18px; }
.stat-box { flex:1; text-align:center; }
.stat-label { text-transform:uppercase; font-size:.7rem; letter-spacing:.4px; color:#8ea2cc; }
.stat-value { font-size:1rem; font-weight:700; color:#38bdf8; }
.section-label { font-size:.75rem; color:#8ea2cc; text-transform:uppercase; letter-spacing:.4px; margin-top:10px; }
.section-text { font-size:.95rem; color:#e2e8f0; margin-bottom:6px; }
.forecast-panel { margin-top:12px; background:rgba(15,23,42,.72); border:1px solid rgba(148,163,184,.25); border-radius:16px; padding:14px 16px 16px; }
.forecast-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:12px; }
.forecast-cell { background:rgba(15,23,42,.92); border-radius:12px; padding:10px 12px; border:1px solid rgba(148,163,184,.2); text-align:center; }
.forecast-label { font-size:.7rem; text-transform:uppercase; color:#9fb4d9; letter-spacing:.08em; }
.forecast-value { font-size:1.1rem; font-weight:700; color:#fbbf24; margin-top:4px; }
.offers-toggle { position:absolute; top:16px; right:16px; width:34px; height:34px; border-radius:50%; background:rgba(255,255,255,.08); color:#d4dbee; display:flex; align-items:center; justify-content:center; transition:transform .3s ease, background .3s ease; cursor:pointer; }
.offer-toggle-label { font-size:0.7rem; margin-right:6px; color:#cbd5f5; text-transform:uppercase; letter-spacing:0.08em; }
.offer-panel h5 { color:#93c5fd; font-size:.85rem; letter-spacing:.5px; }
.offer-list { display:flex; gap:12px; flex-wrap:wrap; }
.offer-item { flex:1 1 calc(33% - 8px); min-width:120px; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.08); background:rgba(15,23,42,.8); animation:fadeUp .4s ease forwards; }
.offer-item img { width:100%; height:90px; object-fit:cover; }
.offer-item div { padding:8px 10px; font-size:.8rem; color:#f8fafc; }

/* Modal for offers */
.offer-modal {
  position:fixed;
  inset:0;
  background:rgba(15,23,42,0.82);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.offer-modal-inner {
  background:#020617;
  border-radius:20px;
  max-width:900px;
  width:96vw;
  max-height:90vh;
  overflow:auto;
  box-shadow:0 30px 90px rgba(0,0,0,0.9);
  border:1px solid rgba(148,163,184,0.3);
}
.offer-modal-header {
  padding:16px 20px 10px;
  border-bottom:1px solid rgba(30,64,175,0.7);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.offer-modal-header h4 { margin:0; color:#e5e7eb; }
.offer-modal-header small { color:#9ca3af; }
.offer-modal-close {
  border:none;
  background:transparent;
  color:#9ca3af;
  font-size:1.4rem;
  cursor:pointer;
}
.offer-modal-body {
  padding:14px 18px 18px;
}
.offer-modal-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.offer-modal-item {
  border-radius:14px;
  overflow:hidden;
  background:rgba(15,23,42,0.95);
  border:1px solid rgba(148,163,184,0.4);
}
.offer-modal-item img {
  width:100%; height:180px; object-fit:cover;
}
.offer-modal-item-body {
  padding:10px 12px 12px;
}
.offer-modal-label {
  font-size:0.7rem;
  text-transform:uppercase;
  letter-spacing:0.12em;
  color:#93c5fd;
  margin-bottom:4px;
}
.offer-modal-title {
  font-size:0.9rem;
  color:#e5e7eb;
}
@keyframes fadeUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
@media(max-width:768px){ .offer-list { flex-direction:column; } }
</style>

<section class="top-product-stage">
  <h1>Top Product — Full Price</h1>
  <p>Tap any card to reveal up to three offer ideas per product from the <strong>three_offer</strong> sheet.</p>

  <div class="product-grid">
    {% for row in rows %}
    <article class="product-card" id="card-{{ loop.index }}" data-product="{{ row.ProductKey }}" onclick="openOfferModalFromElement(this);">
      <div class="offers-toggle">
        <span class="offer-toggle-label">Offers</span>
        <span>+</span>
      </div>
      <div class="card-inner product-card-body-click">
        <div class="product-img">
          {% if row.Image_URL and row.Image_URL != 'Placeholder' %}
            <img src="{{ row.Image_URL }}" alt="{{ row.Product }}">
          {% else %}
            <img src="https://images.unsplash.com/photo-1527004013197-933c4bb611b3?auto=format&fit=crop&w=600&q=60" alt="product">
          {% endif %}
        </div>
        <div class="product-body">
          <div class="d-flex align-items-center">
            <span class="rank-badge">{{ row.No }}</span>
            <div class="product-name">{{ row.Product }}</div>
          </div>
          <div class="stat-row">
            <div class="stat-box">
              <div class="stat-label">Sold Qty</div>
              <div class="stat-value">{{ "{:,.0f}".format(row.Current_Qty) if row.Current_Qty else "–" }}</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Sales (MMK)</div>
              <div class="stat-value" style="color:#f472b6;">{{ "{:,.0f}".format(row.Sale_Total) if row.Sale_Total else "–" }}</div>
            </div>
          </div>
          <div class="section-label">Insight</div>
          <div class="section-text">{{ row.Insight or 'No insight shared' }}</div>
          <div class="section-label">Strategy</div>
          <div class="section-text">{{ row.Strategy_Focus or 'Upcoming strategy TBD' }}</div>

          <div class="section-label">Forecast</div>
          <div class="forecast-panel">
            <div class="forecast-grid">
              {% for q in ['Q1_Forecast', 'Q2_Forecast', 'Q3_Forecast', 'Q4_Forecast'] %}
              <div class="forecast-cell">
                <div class="forecast-label">{{ q[0:2] }}</div>
                <div class="forecast-value">{{ "{:,.0f}".format(row[q]) if row[q] else "–" }}</div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {# offers are now shown in a modal, not inline #}
      </div>
    </article>
    {% endfor %}
  </div>
</section>

{# Offer modal #}
<div class="offer-modal" id="offerModal">
  <div class="offer-modal-inner">
    <div class="offer-modal-header">
      <div>
        <h4 id="offerModalTitle">Offers</h4>
        <small id="offerModalSubtitle"></small>
      </div>
      <button class="offer-modal-close" onclick="closeOfferModal()">&times;</button>
    </div>
    <div class="offer-modal-body">
      <div class="offer-modal-grid" id="offerModalGrid"></div>
    </div>
  </div>
</div>

<script>
  // Offers data passed from backend as mapping: product -> list of offers
  const offersByProduct = {{ offers_by_product | tojson | safe }} || {};

  function openOfferModalFromElement(el){
    const productName = el.getAttribute('data-product') || '';
    openOfferModal(productName);
  }

  function openOfferModal(productName){
    const modal = document.getElementById('offerModal');
    const grid = document.getElementById('offerModalGrid');
    const titleEl = document.getElementById('offerModalTitle');
    const subtitleEl = document.getElementById('offerModalSubtitle');

    const offers = offersByProduct[productName] || [];

    titleEl.textContent = productName || 'Offers';
    subtitleEl.textContent = offers.length ? `${offers.length} configured offer(s)` : 'No offers configured in three_offer sheet.';

    grid.innerHTML = '';
    offers.forEach(off => {
      const card = document.createElement('div');
      card.className = 'offer-modal-item';
      card.innerHTML = `
        ${off.img ? `<img src="${off.img}" alt="offer">` : ''}
        <div class="offer-modal-item-body">
          ${off.label ? `<div class="offer-modal-label">${off.label}</div>` : ''}
          <div class="offer-modal-title">${off.title}</div>
        </div>
      `;
      grid.appendChild(card);
    });

    modal.style.display = 'flex';
  }

  function closeOfferModal(){
    const modal = document.getElementById('offerModal');
    modal.style.display = 'none';
  }

  // close modal when clicking directly on the overlay (outside the inner card)
  const offerModalEl = document.getElementById('offerModal');
  if (offerModalEl) {
    offerModalEl.addEventListener('click', (event) => {
      if (event.target === offerModalEl) {
        closeOfferModal();
      }
    });
  }
</script>
{% endblock %}
